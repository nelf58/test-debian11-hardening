---

- name: Wazuh | create /etc/modprobe.d/ for modprobe conf files
  file:
    path: /etc/modprobe.d
    state: directory

- name: Wazuh | 2506 | Ensure mounting of FAT filesystems is disabled | modprobe
  modprobe:
    name: vfat
    state: absent
  when: disable_vfat

- name: Wazuh | 2506 | Ensure mounting of FAT filesystems is disabled | /etc/modprobe.d/
  lineinfile:
    dest: /etc/modprobe.d/vfat.conf
    regexp: "^.*install vfat.*$"
    line: "install vfat /bin/true"
    create: true
  when: disable_vfat

- name: Wazuh | 2524 | Disable USB Storage | /etc/modprobe.d/
  lineinfile:
    dest: /etc/modprobe.d/usb_storage.conf
    regexp: "^.*install usb-storage.*$"
    line: "install usb-storage /bin/true"
    create: true

- name: Wazuh | 2524 | Disable USB Storage | modprobe
  modprobe:
    name: usb-storage
    state: absent

- name: Wazuh | create /etc/sudoers.d/ for sudo conf files
  file:
    path: /etc/sudoers.d
    state: directory

- name: Wazuh | 2526 | Ensure sudo commands use pty
  lineinfile:
    dest: /etc/sudoers.d/pty
    regexp: "^.*Defaults use_pty.*"
    line: "Defaults use_pty"
    validate: "visudo -cf %s"
    create: yes

- name: Wazuh | 2527 | Ensure sudo log file exists
  lineinfile:
    dest: /etc/sudoers.d/sudo_logs
    regexp: "^.*Defaults logfile.*"
    line: 'Defaults logfile="/var/log/sudo.log"'
    validate: "visudo -cf %s"
    create: yes
    state: present

- name: Wazuh | 2528 | Ensure AIDE is installed | apt
  apt:
    pkg:
    - aide
    - aide-common

- name: Wazuh | 2528 | Ensure AIDE is installed | DB stat
  stat: path=/var/lib/aide/aide.db
  register: aide_db_stat

- name: Wazuh | 2528 | Ensure AIDE is installed | init
  shell: aideinit
  args:
    executable: /bin/bash
  when: aide_db_stat.stat.exists == False

- name: Wazuh | 2528 | Ensure AIDE is installed | DB new stat
  stat: path=/var/lib/aide/aide.db.new
  register: aide_db_new_stat

- name: Wazuh | 2528 | Ensure AIDE is installed | DB copy
  copy:
    src: /var/lib/aide/aide.db.new
    dest: /var/lib/aide/aide.db
  when: 
    - aide_db_new_stat.stat.exists
    - aide_db_stat.stat.exists == False

- name: Wazuh | 2528 | Ensure AIDE is installed | DB new delete
  file:
    path: /var/lib/aide/aide.db.new
    state: absent

- name: Wazuh | 2529 | Ensure filesystem integrity is regularly checked
  cron:
    name: AIDE filesystem check
    user: root
    minute: "0"
    hour: "5"
    day: "*"
    month: "*"
    weekday: "*"
    job: "/usr/bin/aide --config /etc/aide/aide.conf --check"

- name: Wazuh | 2530 | Ensure permissions on bootloader config are configured
  file:
    path: "/boot/grub/grub.cfg"
    mode: 0400
    owner: root
    group: root

######## TO DO ########
### - name: Wazuh | 2531 | Ensure bootloader password is set

- name: Wazuh | 2532 | Ensure authentication required for single user mode
  shell: grep "^root:[*\!\:]" /etc/shadow
  register: root_password_check
  changed_when: false
  failed_when: false
  check_mode: no

- name: Wazuh | 2532 | Ensure authentication required for single user mode | generate password
  set_fact:
    root_password: "{{ root_password_gen }}"
  when: 
    - root_password_check.rc == 0

- name:  Wazuh | 2532 | Ensure authentication required for single user mode | set root password
  user:
    name: "root"
    state: present
    password: "{{ root_password | password_hash('sha512') }}"
  when: 
    - root_password_check.rc == 0

- name: Wazuh | 2536 | Ensure core dumps are restricted | limits
  lineinfile:
    dest: /etc/security/limits.d/core.conf
    line: "*               hard    core            0"
    regexp: '^\s*(#)?\*\s+hard\s+core\s+\d+'
    create: true

- name: Wazuh | 2536 | Ensure core dumps are restricted
  sysctl:
    name: fs.suid_dumpable
    value: "0"
    sysctl_file: /etc/sysctl.d/fs-suid_dumpable.conf | sysctl
    state: present
    reload: true
    sysctl_set: true

- name: Wazuh | 2536 | Ensure core dumps are restricted | apt
  apt:
    name: systemd-coredump
    state: present

- name: Wazuh | 2536 | Ensure core dumps are restricted | daemon_reload
  systemd:
    daemon_reload: yes

- name: Wazuh | 2541 | Ensure message of the day is configured properly
  template:
    src: motd.j2
    dest: /etc/motd
    mode: 0644
    owner: root
    group: root

- name: Wazuh | 2542 | Ensure local login warning banner is configured properly 
  template:
    src: issue.j2
    dest: /etc/issue
    owner: root
    group: root
    mode: 0644

- name: Wazuh | 2543 | Ensure remote login warning banner is configured properly
  template:
    src: issue.net.j2
    dest: /etc/issue.net
    owner: root
    group: root
    mode: 0644

- name: Wazuh | 2548 | Ensure updates, patches, and additional security software are installed
  apt:
    upgrade: yes
    update_cache: yes

- name: Wazuh | 2552 | Ensure systemd-timesyncd is configured | apt
  apt:
    pkg:
    - systemd-timesyncd

- name: Wazuh | 2552 | Ensure systemd-timesyncd is configured | config
  lineinfile:
    dest: /etc/sysctl.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^\s*#*\s*NTP\s*=.*', line: 'NTP=0.debian.pool.ntp.org 1.debian.pool.ntp.org' }
    - { regexp: '^\s*#*\s*FallbackNTP\s*=.*', line: 'FallbackNTP=2.debian.pool.ntp.org 3.debian.pool.ntp.org' }
    - { regexp: '^\s*#*\s*RootDistanceMax\s*=.*', line: 'RootDistanceMax=1' }
  notify: Restart systemd-timesyncd

- name: Wazuh | 2552 | Ensure systemd-timesyncd is configured | service
  service:
    name: systemd-timesyncd
    enabled: yes
    state: started
